# need to update configure.ac before this works
#CXX := @CXX@
INSTALL := @INSTALL@

vers := @PACKAGE_VERSION@

prefix := @prefix@
exec_prefix := @exec_prefix@
sbindir := @sbindir@
sysconfdir := @sysconfdir@
libexecdir := @libexecdir@
localstatedir := @localstatedir@
datarootdir := @datarootdir@
datadir := @datadir@

all: hcopy src/hcopy.sh src/hdfs-xrootd-hworker src/hdfs-xrootd-healer config/hdfs-xrootd-healer.cfg

clean:
	rm -f *.o hcopy src/hdfs-xrootd-healer src/hdfs-xrootd-hworker src/hdfs-xrootd-hcopy config/*.cfg hdfs-xrootd-healer-$(vers).tar.gz

distclean: clean
	rm -f Makefile config.status config.log

hcopy: hcopy.o md5.o
	${CXX} -g $^ -o $@ -lhdfs

%.o: src/%.cxx
	${CXX} -g -O2 -c $< -o $@

src/hcopy.sh: src/hcopy.sh.in 
	sed -e 's|[@]libexecdir@|$(libexecdir)|' $< > $@

src/hdfs-xrootd-hworker: src/hdfs-xrootd-hworker.in 
	sed -e 's|[@]libexecdir@|$(libexecdir)|' $< > $@

src/hdfs-xrootd-healer: src/hdfs-xrootd-healer.in 
	sed -e 's|[@]sysconfdir@|$(sysconfdir)|' \
	-e 's|[@]libexecdir@|$(libexecdir)|' \
	-e 's|[@]localstatedir@|$(localstatedir)|' $< > $@

config/hdfs-xrootd-healer.cfg: config/hdfs-xrootd-healer.cfg.in 
	sed 's|[@]localstatedir@|$(localstatedir)|' $< > $@

install: all
	mkdir -p $(DESTDIR)$(sbindir)
	$(INSTALL) src/hdfs-xrootd-healer $(DESTDIR)$(sbindir)
	mkdir -p $(DESTDIR)$(datadir)/hdfs-xrootd-healer
	$(INSTALL) -m 644 config/hdfs-xrootd-healer.{cfg,cron,init,logrotate} \
	$(DESTDIR)$(datadir)/hdfs-xrootd-healer
	mkdir -p $(DESTDIR)$(localstatedir)/log/hdfs-xrootd-healer

uninstall:
	rm -rf $(DESTDIR)$(sbindir)/hdfs-xrootd-healer
	rm -rf $(DESTDIR)$(datadir)/hdfs-xrootd-healer

dist:
	rsync -avR autom4te.cache \
	config/hdfs-xrootd-healer.{cfg.in,cron,init,logrotate} \
	configure configure.ac install-sh Makefile.in \
	src/hdfs-xrootd-healer.in hdfs-xrootd-healer-$(vers)/
	rsync -av ../README ../LICENSE ../NEWS hdfs-xrootd-healer-$(vers)/
	tar -czf hdfs-xrootd-healer-$(vers).tar.gz hdfs-xrootd-healer-$(vers)
	rm -rf hdfs-xrootd-healer-$(vers)
