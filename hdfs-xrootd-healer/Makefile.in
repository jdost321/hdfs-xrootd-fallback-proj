HADOOP_HOME := @HADOOP_HOME@
HADOOP_HDFS_HOME := @HADOOP_HDFS_HOME@
HADOOP_CLIENT := @HADOOP_CLIENT@
HADOOP_LIBEXEC_DIR := @HADOOP_LIBEXEC_DIR@

prefix := @prefix@
exec_prefix := @exec_prefix@
bindir := @bindir@
sysconfdir := @sysconfdir@
libdir := @libdir@
localstatedir := @localstatedir@

hd_common_jar := $(HADOOP_HOME)/hadoop-common.jar
hd_annotations_jar := $(HADOOP_HOME)/hadoop-annotations.jar
hd_hdfs_jar := $(HADOOP_HDFS_HOME)/hadoop-hdfs.jar

all: hdfs-xrootd-healer.jar hdfs_xrootd_healer.sh hdfs-xrootd-healer.cfg

clean:
	rm -f edu/ucsd/t2/hdfs/xrootd/healer/*.class *.jar hdfs_xrootd_healer.sh *.cfg

hdfs-xrootd-healer.jar: edu/ucsd/t2/hdfs/xrootd/healer/BlockHealer.class \
edu/ucsd/t2/hdfs/xrootd/healer/Block.class \
edu/ucsd/t2/hdfs/xrootd/healer/Config.class \
edu/ucsd/t2/hdfs/xrootd/healer/Logger.class \
edu/ucsd/t2/hdfs/xrootd/healer/HdfsUtil.class \
edu/ucsd/t2/hdfs/xrootd/healer/HdfsUtil$$BadBlockStream.class \
edu/ucsd/t2/hdfs/xrootd/healer/HdfsUtil$$BadFileStream.class \
edu/ucsd/t2/hdfs/xrootd/healer/HdfsUtil$$BlockSizeStream.class \
edu/ucsd/t2/hdfs/xrootd/healer/HdfsUtil$$BlockStream.class \
edu/ucsd/t2/hdfs/xrootd/healer/HdfsUtil$$MessageStream.class \
edu/ucsd/t2/hdfs/xrootd/healer/HdfsUtil$$NullStream.class \
edu/ucsd/t2/hdfs/xrootd/healer/HdfsUtil$$NullStream$$1.class \
square_pusher.sh
	jar cvf $@ $(patsubst %,'%',$^)

%.class: %.java
	javac -classpath .:$(hd_common_jar):$(hd_hdfs_jar):$(hd_annotations_jar) $<

hdfs_xrootd_healer.sh: hdfs_xrootd_healer.sh.in 
	sed -e 's|[@]libdir@|$(libdir)|' \
	-e 's|[@]sysconfdir@|$(sysconfdir)|' \
	-e 's|[@]HADOOP_LIBEXEC_DIR@|$(HADOOP_LIBEXEC_DIR)|' $< > $@

hdfs-xrootd-healer.cfg: hdfs-xrootd-healer.cfg.in 
	sed 's|[@]localstatedir@|$(localstatedir)|' $< > $@

install: all
	mkdir -p $(DESTDIR)$(libdir)/hdfs-xrootd-healer
	install -m 644 hdfs-xrootd-healer.jar $(DESTDIR)$(libdir)/hdfs-xrootd-healer
	mkdir -p $(DESTDIR)$(bindir)
	install hdfs_xrootd_healer.sh $(DESTDIR)$(bindir)
	mkdir -p $(DESTDIR)$(sysconfdir)/hdfs-xrootd-healer
	install -m 644 hdfs-xrootd-healer.cfg $(DESTDIR)$(sysconfdir)/hdfs-xrootd-healer
	mkdir -p $(DESTDIR)$(localstatedir)/log/hdfs-xrootd-healer

uninstall:
	rm -rf $(DESTDIR)$(libdir)/hdfs-xrootd-healer
	rm -rf $(DESTDIR)$(sysconfdir)/hdfs-xrootd-healer
	rm -rf $(DESTDIR)$(localstatedir)/log/hdfs-xrootd-healer
	rm -f $(DESTIDIR)$(bindir)/hdfs_xrootd_healer.sh
