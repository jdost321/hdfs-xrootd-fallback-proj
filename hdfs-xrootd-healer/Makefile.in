HADOOP_HOME := @HADOOP_HOME@
HADOOP_HDFS_HOME := @HADOOP_HDFS_HOME@
HADOOP_LIBEXEC_DIR := @HADOOP_LIBEXEC_DIR@

INSTALL := @INSTALL@

vers := @PACKAGE_VERSION@

prefix := @prefix@
exec_prefix := @exec_prefix@
libexecdir := @libexecdir@
sysconfdir := @sysconfdir@
libdir := @libdir@
localstatedir := @localstatedir@
datarootdir := @datarootdir@
datadir := @datadir@

hd_common_jar := $(HADOOP_HOME)/hadoop-common.jar
hd_annotations_jar := $(HADOOP_HOME)/hadoop-annotations.jar
hd_hdfs_jar := $(HADOOP_HDFS_HOME)/hadoop-hdfs.jar

all: hdfs-xrootd-healer.jar src/hdfs_xrootd_healer.sh config/hdfs-xrootd-healer.cfg

clean:
	rm -f src/edu/ucsd/t2/hdfs/xrootd/healer/*.class *.jar src/hdfs_xrootd_healer.sh config/*.cfg hdfs-xrootd-healer-$(vers).tar.gz

distclean: clean
	rm -f Makefile config.status config.log

hdfs-xrootd-healer.jar: src/edu/ucsd/t2/hdfs/xrootd/healer/BlockHealer.class \
src/edu/ucsd/t2/hdfs/xrootd/healer/Block.class \
src/edu/ucsd/t2/hdfs/xrootd/healer/Config.class \
src/edu/ucsd/t2/hdfs/xrootd/healer/Logger.class \
src/edu/ucsd/t2/hdfs/xrootd/healer/HdfsUtil.class \
src/edu/ucsd/t2/hdfs/xrootd/healer/HdfsUtil$$BadBlockStream.class \
src/edu/ucsd/t2/hdfs/xrootd/healer/HdfsUtil$$BadFileStream.class \
src/edu/ucsd/t2/hdfs/xrootd/healer/HdfsUtil$$BlockSizeStream.class \
src/edu/ucsd/t2/hdfs/xrootd/healer/HdfsUtil$$BlockStream.class \
src/edu/ucsd/t2/hdfs/xrootd/healer/HdfsUtil$$MessageStream.class \
src/edu/ucsd/t2/hdfs/xrootd/healer/HdfsUtil$$NullStream.class \
src/edu/ucsd/t2/hdfs/xrootd/healer/HdfsUtil$$NullStream$$1.class \
src/square_pusher.sh
	jar cvf $@ $(patsubst src/%,-C src '%',$^)

%.class: %.java
	javac -classpath src:$(hd_common_jar):$(hd_hdfs_jar):$(hd_annotations_jar) $<

src/hdfs_xrootd_healer.sh: src/hdfs_xrootd_healer.sh.in 
	sed -e 's|[@]libdir@|$(libdir)|' \
	-e 's|[@]sysconfdir@|$(sysconfdir)|' \
	-e 's|[@]HADOOP_LIBEXEC_DIR@|$(HADOOP_LIBEXEC_DIR)|' $< > $@

config/hdfs-xrootd-healer.cfg: config/hdfs-xrootd-healer.cfg.in 
	sed 's|[@]localstatedir@|$(localstatedir)|' $< > $@

install: all
	mkdir -p $(DESTDIR)$(libdir)/hdfs-xrootd-healer
	$(INSTALL) -m 644 hdfs-xrootd-healer.jar $(DESTDIR)$(libdir)/hdfs-xrootd-healer
	mkdir -p $(DESTDIR)$(libexecdir)/hdfs-xrootd-healer
	$(INSTALL) src/hdfs_xrootd_healer.sh $(DESTDIR)$(libexecdir)/hdfs-xrootd-healer
	mkdir -p $(DESTDIR)$(datadir)/hdfs-xrootd-healer
	$(INSTALL) -m 644 config/hdfs-xrootd-healer.cfg config/hdfs-xrootd-healer.cron \
	config/hdfs-xrootd-healer.init config/hdfs-xrootd-healer.logrotate \
	$(DESTDIR)$(datadir)/hdfs-xrootd-healer
	mkdir -p $(DESTDIR)$(localstatedir)/log/hdfs-xrootd-healer

uninstall:
	rm -rf $(DESTDIR)$(libdir)/hdfs-xrootd-healer
	rm -rf $(DESTDIR)$(datadir)/hdfs-xrootd-healer
	rm -rf $(DESTDIR)$(libexecdir)/hdfs-xrootd-healer

dist:
	rsync -avR autom4te.cache \
	config/{hdfs-xrootd-healer.cfg.in,hdfs-xrootd-healer.cron,hdfs-xrootd-healer.init,hdfs-xrootd-healer.logrotate} \
	configure configure.ac install-sh Makefile.in \
	src/{hdfs_xrootd_healer.sh.in,square_pusher.sh} \
	src/edu/ucsd/t2/hdfs/xrootd/healer/*.java hdfs-xrootd-healer-$(vers)/
	tar -czf hdfs-xrootd-healer-$(vers).tar.gz hdfs-xrootd-healer-$(vers)
	rm -rf hdfs-xrootd-healer-$(vers)
